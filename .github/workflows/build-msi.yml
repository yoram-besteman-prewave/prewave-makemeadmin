name: Build MSI Installer

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-x64:
    name: Build x64 MSI
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Install WiX Toolset
      run: choco install wixtoolset -y --no-progress
      shell: cmd
        
    - name: Restore NuGet Packages
      run: nuget restore "MakeMeAdmin.sln" -NonInteractive
      shell: cmd
      
    - name: Build All Projects EXCEPT Setup (x64)
      run: |
        msbuild "Enumerations\Enumerations.csproj" /p:Configuration=Release /p:Platform=x64
        msbuild "LsaLogonSessions\LsaLogonSessions.csproj" /p:Configuration=Release /p:Platform=x64
        msbuild "Settings\Settings.csproj" /p:Configuration=Release /p:Platform=x64
        msbuild "Logging\Logging.csproj" /p:Configuration=Release /p:Platform=x64
        msbuild "UserList\UserList.csproj" /p:Configuration=Release /p:Platform=x64
        msbuild "ProcessCommunication\ProcessCommunication.csproj" /p:Configuration=Release /p:Platform=x64
        msbuild "Service\Service.csproj" /p:Configuration=Release /p:Platform=x64
        msbuild "UserRequestApp\LocalUI.csproj" /p:Configuration=Release /p:Platform=x64
        msbuild "RemoteUI\RemoteUI.csproj" /p:Configuration=Release /p:Platform=x64
        msbuild "WiXCustomAction\WiXCustomAction.csproj" /p:Configuration=Release /p:Platform=x64
      shell: cmd
      
    - name: Build Setup Project (x64)
      run: msbuild "Setup\Setup.wixproj" /p:Configuration=Release /p:Platform=x64 /v:detailed
      shell: cmd
      
    - name: List MSI Files
      run: dir /s /b *.msi
      shell: cmd
        
    - name: Upload x64 MSI
      uses: actions/upload-artifact@v4
      with:
        name: MakeMeAdmin-x64-Installer
        path: "**/*x64*.msi"

  build-x86:
    name: Build x86 MSI  
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Install WiX Toolset
      run: choco install wixtoolset -y --no-progress
      shell: cmd
        
    - name: Restore NuGet Packages
      run: nuget restore "MakeMeAdmin.sln" -NonInteractive
      shell: cmd
      
    - name: Build All Projects EXCEPT Setup (x86)
      run: |
        msbuild "Enumerations\Enumerations.csproj" /p:Configuration=Release /p:Platform=x86
        msbuild "LsaLogonSessions\LsaLogonSessions.csproj" /p:Configuration=Release /p:Platform=x86
        msbuild "Settings\Settings.csproj" /p:Configuration=Release /p:Platform=x86
        msbuild "Logging\Logging.csproj" /p:Configuration=Release /p:Platform=x86
        msbuild "UserList\UserList.csproj" /p:Configuration=Release /p:Platform=x86
        msbuild "ProcessCommunication\ProcessCommunication.csproj" /p:Configuration=Release /p:Platform=x86
        msbuild "Service\Service.csproj" /p:Configuration=Release /p:Platform=x86
        msbuild "UserRequestApp\LocalUI.csproj" /p:Configuration=Release /p:Platform=x86
        msbuild "RemoteUI\RemoteUI.csproj" /p:Configuration=Release /p:Platform=x86
        msbuild "WiXCustomAction\WiXCustomAction.csproj" /p:Configuration=Release /p:Platform=x86
      shell: cmd
      
    - name: Build Setup Project (x86)
      run: msbuild "Setup\Setup.wixproj" /p:Configuration=Release /p:Platform=x86 /v:detailed
      shell: cmd
      
    - name: List MSI Files
      run: dir /s /b *.msi
      shell: cmd
        
    - name: Upload x86 MSI
      uses: actions/upload-artifact@v4
      with:
        name: MakeMeAdmin-x86-Installer
        path: "**/*x86*.msi"
