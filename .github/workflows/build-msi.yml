name: Build MSI Installer

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-x64:
    name: Build x64 MSI
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Install WiX Toolset
      run: choco install wixtoolset -y --no-progress
      shell: cmd
        
    - name: Restore NuGet Packages
      run: nuget restore "MakeMeAdmin.sln" -NonInteractive
      shell: cmd
      
    - name: Build All C# Projects First (x64)
      run: msbuild "MakeMeAdmin.sln" /p:Configuration=Release /p:Platform=x64 /t:Enumerations;LsaLogonSessions;Settings;Logging;UserList;ProcessCommunication;Service;LocalUI;RemoteUI;WiXCustomAction /m
      shell: cmd
      
    - name: Wait for files to be ready
      run: timeout /t 2 /nobreak
      shell: cmd
      
    - name: Build Setup via Solution (x64)
      run: msbuild "MakeMeAdmin.sln" /p:Configuration=Release /p:Platform=x64 /t:Setup /m
      shell: cmd
      
    - name: List MSI Files
      run: dir /s /b *.msi
      shell: cmd
        
    - name: Upload x64 MSI
      uses: actions/upload-artifact@v4
      with:
        name: MakeMeAdmin-x64-Installer
        path: "**/*x64*.msi"

  build-x86:
    name: Build x86 MSI  
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Install WiX Toolset
      run: choco install wixtoolset -y --no-progress
      shell: cmd
        
    - name: Restore NuGet Packages
      run: nuget restore "MakeMeAdmin.sln" -NonInteractive
      shell: cmd
      
    - name: Build All C# Projects First (x86)
      run: msbuild "MakeMeAdmin.sln" /p:Configuration=Release /p:Platform=x86 /t:Enumerations;LsaLogonSessions;Settings;Logging;UserList;ProcessCommunication;Service;LocalUI;RemoteUI;WiXCustomAction /m
      shell: cmd
      
    - name: Wait for files to be ready
      run: timeout /t 2 /nobreak
      shell: cmd
      
    - name: Build Setup via Solution (x86)
      run: msbuild "MakeMeAdmin.sln" /p:Configuration=Release /p:Platform=x86 /t:Setup /m
      shell: cmd
      
    - name: List MSI Files
      run: dir /s /b *.msi
      shell: cmd
        
    - name: Upload x86 MSI
      uses: actions/upload-artifact@v4
      with:
        name: MakeMeAdmin-x86-Installer
        path: "**/*x86*.msi"
